name: Deploy to Vultr VM

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
  workflow_run:
    workflows: ["Create Release"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if workflow_run succeeded, or if triggered by tag push or manual
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Deploying version: $VERSION"
          else
            echo "version=manual" >> $GITHUB_OUTPUT
            echo "Manual deployment (no tag)"
          fi

      - name: GitOps Deploy to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # GitOps: Ensure repository exists
            if [ ! -d "/opt/ctools/.git" ]; then
              echo "ðŸ“¦ Initial setup: Cloning repository..."
              sudo mkdir -p /opt/ctools
              sudo chown ${{ secrets.VM_USER }}:${{ secrets.VM_USER }} /opt/ctools
              git clone https://github.com/${{ github.repository }} /opt/ctools
            fi

            # Pull latest code first to get deployment scripts
            cd /opt/ctools
            git fetch origin master
            git reset --hard origin/master

            # GitOps: Run declarative deployment script from repository
            chmod +x deploy/deploy.sh
            ./deploy/deploy.sh

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.VM_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.version.outputs.version }}" != "manual" ]]; then
            echo "Deployed tagged version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "Manual deployment triggered" >> $GITHUB_STEP_SUMMARY
          fi
